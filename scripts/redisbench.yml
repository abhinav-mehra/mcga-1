# ~/.tmuxinator/redisbench.yml

name: redisbench
root: /home/vikas/mcga
tmux_command: byobu

windows:
  - redis:
      layout: main-vertical
      root: /home/vikas/mcga/src/bench/redis-3.0/src
      panes:
        - server:
            - mkdir -p ~/results
            - rm -rf ~/results/*
            #- cat /proc/vmstat | grep thp > ~/results/thp_begin
            - sudo sh -c "echo 1000 > /sys/kernel/mm/transparent_hugepage/khugepaged/scan_sleep_millisecs"
            - sudo sh -c "sync; echo 3 > /proc/sys/vm/drop_caches"
            - rm -rf dump.rdb
            - ./redis-server ../redis.conf
        - benchmark:
            - rm -rf benchmark.log
            - rm -rf benchmark-stats.log
            - sleep 5
            - ./redis-benchmark -P 50 -t set -r 200000000 -n 240000000 | grep -v "SET:" | tee -a benchmark-stats.log
            - cp benchmark.log ~/results/
            - cp benchmark-stats.log ~/results/
            - kill -9 `pgrep redis-cli`
            - sudo ps ef | grep perf | grep dTLB | awk '{print $1}' | xargs sudo kill -2
            - sleep 240
            - sudo killall -2 perf
            - kill -9 `pgrep redis-server`
            #- cat /proc/vmstat | grep thp > ~/results/thp_end
        - cli:
            - rm -rf latency.log
            - sleep 5
            - ./redis-cli --latency-history -i 1 | tee -a latency.log
            - cp latency.log ~/results/
  - perflogs:
      layout: main-vertical
      root: /home/vikas/mcga/src/linux-4.1.19/tools/perf
      panes:
        - khugepaged-perf:
            - sleep 7
            - sudo sh -c "./perf stat -e cycles,instructions -p `pgrep khugepaged` 2> /tmp/khugepaged-perf"
            - sudo mv /tmp/khugepaged-perf ~/results/
        - redis-perf:
            - sleep 7
            - sudo sh -c "./perf stat -e dTLB-load-misses,dTLB-store-misses,iTLB-load-misses,cache-misses,L1-dcache-load-misses,L1-dcache-store-misses,L1-dcache-prefetch-misses,L1-icache-load-misses,LLC-load-misses,LLC-store-misses,LLC-prefetch-misses,branch-load-misses,node-load-misses,node-store-misses,node-prefetch-misses,minor-faults -p `pgrep redis-server` 2> /tmp/redis-perf"
            - sudo mv /tmp/redis-perf ~/results/
  - rss:
      root: /home/vikas/mcga/scripts/plotters
      panes:
        - logs:
            - sleep 3
            - ./getRssAnonHugePages.sh
            - cp *.out ~/results/
