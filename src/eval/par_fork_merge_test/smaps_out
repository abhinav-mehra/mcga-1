#!/bin/bash

CLI="mfork"
PID=`ps -e | grep $CLI | awk '{print $1}'`
DATE=`date +%T`
echo pid is $PID cmd is $CLI
echo $PID > /proc/sys/debug/pgt_dump_process_id
while read CMD; do
	[ -z "$CMD" ] && continue
	case "$CMD" in
	E)
	echo input is E
	cp /proc/$PID/smaps fork_results/1_bef_fork_par$DATE
	cat /sys/kernel/debug/kernel_page_tables > fork_results/1_bef_fork_pgtbl_par$DATE
	;;
	F)
	echo input is F
	CPID=`ps -e | grep $CLI | tail -n 1 | awk '{print $1}'`
	cp /proc/$PID/smaps fork_results/2_af_fork_par$DATE
	cp /proc/$CPID/smaps fork_results/2_af_fork_ch$DATE
	;;
	D)
	echo input is D
	CPID=`ps -e | grep $CLI | tail -n 1 | awk '{print $1}'`
	cp /proc/$PID/smaps fork_results/3_af_dir_par$DATE
	cp /proc/$CPID/smaps fork_results/3_af_dir_ch$DATE
	;;
	W)
	echo input is W
	CPID=`ps -e | grep $CLI | tail -n 1 | awk '{print $1}'`
	cp /proc/$PID/smaps fork_results/af_wait_par$DATE
	cp /proc/$CPID/smaps fork_results/af_wait_ch$DATE
	;;
	M)
	echo input is M
	CPID=`ps -e | grep $CLI | tail -n 1 | awk '{print $1}'`
	cp /proc/$PID/smaps fork_results/4_af_merge_par$DATE
	cat /sys/kernel/debug/kernel_page_tables > fork_results/4_af_merge_pgtbl_par$DATE
	;;
	C1)
	echo input is C1
	CPID=`ps -e | grep $CLI | tail -n 1 | awk '{print $1}'`
	cp /proc/$PID/smaps fork_results/5_af_merge_par$DATE
	;;
	*)
		echo "invalid $CMD"
	;;
esac
done
